# üè• Bed Monitor ‚Äî Real-time Dashboard

Real-time patient bed occupancy dashboard powered by **Arduino + HX711 weight sensor + Supabase**.

---

## üìÅ Project Structure

```
bed-monitor/
‚îú‚îÄ‚îÄ index.html          ‚Üê Main HTML (open this in browser)
‚îú‚îÄ‚îÄ package.json        ‚Üê For live-server dev setup
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ style.css       ‚Üê All styles
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ config.js       ‚Üê ‚ö†Ô∏è Supabase credentials (edit this)
‚îÇ   ‚îú‚îÄ‚îÄ helpers.js      ‚Üê Date/time utility functions
‚îÇ   ‚îú‚îÄ‚îÄ ui.js           ‚Üê All DOM rendering logic
‚îÇ   ‚îú‚îÄ‚îÄ realtime.js     ‚Üê Supabase realtime subscriptions
‚îÇ   ‚îî‚îÄ‚îÄ main.js         ‚Üê App entry point
‚îî‚îÄ‚îÄ README.md
```

---

## üöÄ How to Run in VS Code

### Option A ‚Äî Direct Open (Simplest)
1. Open the `bed-monitor` folder in VS Code
2. Right-click `index.html` ‚Üí **Open with Live Server**
3. Dashboard opens at `http://127.0.0.1:5500`

> **Install Live Server extension first:**
> VS Code ‚Üí Extensions ‚Üí Search "Live Server" by Ritwick Dey ‚Üí Install

---

### Option B ‚Äî Terminal / npm
```bash
# 1. Open terminal in VS Code (Ctrl + `)
# 2. Install dependencies
npm install

# 3. Start dev server
npm start
# Opens at http://localhost:3000
```

---

## ‚öôÔ∏è Configuration

Edit `js/config.js` to change your Supabase project:

```js
const CONFIG = {
  SUPABASE_URL: 'https://your-project.supabase.co',
  SUPABASE_KEY: 'your-anon-key',
  BED_ID:       'bed_01',   // Must match your beds table row
  LOG_LIMIT:    100,
};
```

---

## üìä Data Flow

```
Arduino (HX711 sensor)
    ‚Üì POST every 5 sec
pesticide_logs table     ‚Üê full event history
    ‚Üì Postgres trigger
beds table               ‚Üê live current state
    ‚Üì Supabase Realtime
Dashboard updates live
```

---

## üéØ Status Logic

| Arduino Sends  | beds.status | Dashboard Shows |
|---------------|-------------|-----------------|
| `occupied`    | occupied    | üü¢ BED OCCUPIED |
| `empty`       | empty       | üî¥ BED EMPTY    |

---

## üì¶ Supabase Tables Required

### `pesticide_logs`
```sql
CREATE TABLE pesticide_logs (
  id         bigint generated by default as identity primary key,
  weight     float,
  status     text,
  created_at timestamp with time zone default timezone('utc', now())
);
```

### `beds`
```sql
CREATE TABLE beds (
  id           text primary key,
  status       text default 'empty',
  weight       float default 0,
  allotted_at  timestamp with time zone,
  vacated_at   timestamp with time zone,
  updated_at   timestamp with time zone default timezone('utc', now())
);
```

### Postgres Trigger (auto-syncs beds when Arduino inserts)
```sql
CREATE OR REPLACE FUNCTION sync_bed_status()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'occupied' THEN
    UPDATE beds SET status='occupied', weight=NEW.weight,
      allotted_at=now(), vacated_at=NULL, updated_at=now()
    WHERE id = 'bed_01';
  ELSIF NEW.status = 'empty' THEN
    UPDATE beds SET status='empty', weight=NEW.weight,
      vacated_at=now(), updated_at=now()
    WHERE id = 'bed_01';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE TRIGGER on_new_log
AFTER INSERT ON pesticide_logs
FOR EACH ROW EXECUTE FUNCTION sync_bed_status();
```

---

## üîß Troubleshooting

| Problem | Fix |
|---------|-----|
| Dashboard shows OFFLINE | Check Supabase Replication is ON for both tables |
| No data showing | Verify `BED_ID` in config.js matches your beds table |
| Realtime not working | Go to Supabase ‚Üí Database ‚Üí Replication ‚Üí Toggle ON both tables |
| CORS error | Use Live Server extension, don't open index.html directly as a file |
